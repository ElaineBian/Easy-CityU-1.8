<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🍽️ 食堂点餐 - Easy CityU</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🍽️</text></svg>">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/canteen.css">
    <link rel="stylesheet" href="css/fontawesome-local.css">
</head>
<body>
    <div class="canteen-container">
        <a href="main.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            返回主页
        </a>

        <div class="canteen-header">
            <h1><i class="fas fa-utensils"></i> 城大食堂点餐中心</h1>
            <p>在线点餐 · 美食投票 · 便捷服务</p>
        </div>

        <div class="canteen-sections">
            <!-- 点餐区域 -->
            <div class="section-card">
                <h2 class="section-title">
                    <i class="fas fa-shopping-cart"></i> 在线点餐
                </h2>
                <iframe 
                    src="https://csd.order.place/home/store/112870?mode=prekiosk" 
                    class="order-frame"
                    title="食堂点餐系统">
                </iframe>
            </div>

            <!-- 投票区域 -->
            <div class="section-card voting-section">
                <h2 class="section-title">
                    <i class="fas fa-poll"></i> 美食投票
                </h2>
                
                <div class="vote-status">
                    <p><strong>今日投票状态：</strong> <span id="voteStatus">可以投票</span></p>
                    <div class="vote-timer" id="voteTimer"></div>
                </div>

                <div id="foodList">
                    <!-- 食物列表将通过JavaScript动态生成 -->
                </div>

                <div class="top-foods">
                    <h4><i class="fas fa-trophy"></i> 今日人气榜</h4>
                    <div id="topFoodsList">
                        <!-- 排行榜将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 食物数据
        const foods = [
            { id: 1, name: "红烧肉饭", description: "香甜软糯的红烧肉配白米饭", votes: 45 },
            { id: 2, name: "宫保鸡丁", description: "经典川菜，麻辣鲜香", votes: 38 },
            { id: 3, name: "麻婆豆腐", description: "嫩滑豆腐配麻辣汤汁", votes: 32 },
            { id: 4, name: "糖醋里脊", description: "酸甜可口的经典菜品", votes: 28 },
            { id: 5, name: "青椒肉丝", description: "清爽下饭的家常菜", votes: 25 },
            { id: 6, name: "番茄鸡蛋", description: "营养丰富的经典搭配", votes: 22 },
            { id: 7, name: "土豆丝", description: "爽脆可口的素菜", votes: 18 },
            { id: 8, name: "白切鸡", description: "清淡鲜美的粤式菜品", votes: 15 }
        ];

        // 检查用户今日是否已投票
        function hasVotedToday() {
            const lastVoteDate = localStorage.getItem('lastVoteDate');
            const today = new Date().toDateString();
            return lastVoteDate === today;
        }

        // 记录投票
        function recordVote() {
            const today = new Date().toDateString();
            localStorage.setItem('lastVoteDate', today);
        }

        // 获取用户投票数据
        function getUserVotes() {
            const votes = localStorage.getItem('userVotes');
            return votes ? JSON.parse(votes) : {};
        }

        // 保存用户投票数据
        function saveUserVotes(votes) {
            localStorage.setItem('userVotes', JSON.stringify(votes));
        }

        // 投票功能
        function vote(foodId) {
            if (hasVotedToday()) {
                alert('您今天已经投过票了，请明天再来！');
                return;
            }

            const userVotes = getUserVotes();
            if (!userVotes[foodId]) {
                userVotes[foodId] = 0;
            }
            userVotes[foodId]++;
            
            // 更新食物投票数
            const food = foods.find(f => f.id === foodId);
            if (food) {
                food.votes++;
            }

            saveUserVotes(userVotes);
            recordVote();
            
            // 重新渲染页面
            renderFoodList();
            renderTopFoods();
            updateVoteStatus();
            
            // 显示投票成功消息
            showNotification('投票成功！感谢您的参与！', 'success');
        }

        // 渲染食物列表
        function renderFoodList() {
            const foodList = document.getElementById('foodList');
            const hasVoted = hasVotedToday();
            
            foodList.innerHTML = foods.map(food => `
                <div class="food-item">
                    <div class="food-info">
                        <div class="food-name">${food.name}</div>
                        <div class="food-description">${food.description}</div>
                    </div>
                    <div class="vote-section">
                        <div class="vote-count">${food.votes}</div>
                        <button class="vote-btn" onclick="vote(${food.id})" ${hasVoted ? 'disabled' : ''}>
                            ${hasVoted ? '已投票' : '投票'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 渲染排行榜
        function renderTopFoods() {
            const topFoodsList = document.getElementById('topFoodsList');
            const sortedFoods = [...foods].sort((a, b) => b.votes - a.votes).slice(0, 5);
            
            topFoodsList.innerHTML = sortedFoods.map((food, index) => `
                <div class="top-food-item">
                    <span><span class="rank">${index + 1}.</span>${food.name}</span>
                    <span>${food.votes}票</span>
                </div>
            `).join('');
        }

        // 更新投票状态
        function updateVoteStatus() {
            const voteStatus = document.getElementById('voteStatus');
            const voteTimer = document.getElementById('voteTimer');
            
            if (hasVotedToday()) {
                voteStatus.textContent = '今日已投票';
                voteStatus.style.color = '#28a745';
                
                // 计算到明天的剩余时间
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const timeLeft = tomorrow - now;
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                voteTimer.textContent = `距离下次投票还有 ${hours}小时${minutes}分钟`;
            } else {
                voteStatus.textContent = '可以投票';
                voteStatus.style.color = '#007bff';
                voteTimer.textContent = '每人每天只能投一票，请珍惜您的选择！';
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#007bff'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            renderFoodList();
            renderTopFoods();
            updateVoteStatus();
            
            // 每分钟更新一次倒计时
            setInterval(updateVoteStatus, 60000);
        });

        // 主题切换支持
        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        }

        // 应用主题
        applyTheme();
    </script>
</body>
</html>